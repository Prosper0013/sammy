<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>PNL Card Generator</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
    body {
        margin: 0;
        padding: 0;
        font-family: "Poppins", sans-serif;
        background: #0d0d0d;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
    }

    /* -------- LANDSCAPE ONLY -------- */
    @media screen and (orientation: portrait) {
        body::before {
            content: "Rotate your phone â†’ Landscape mode required";
            color: white;
            font-size: 22px;
            text-align: center;
            padding: 40px;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 100;
        }
        .pnl-card { display: none; }
    }

    .pnl-card {
        width: 90%;
        max-width: 950px;
        background: radial-gradient(circle at top, rgba(29, 29, 29, 0.85), rgba(13, 13, 13, 0.9));
        padding: 25px;
        border-radius: 22px;
        box-shadow: 0 0 25px rgba(0,255,200,0.35);
        border: 1px solid rgba(0,255,200,0.25);
        color: white;
        position: relative;
        overflow: hidden;
        z-index: 1;
    }

    /* Blurry background image (kept as pseudo-element but will be preloaded in JS) */
    .pnl-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: url('logo.jpg');
        background-size: cover;
        background-position: center;
        filter: blur(10px) brightness(0.4);
        z-index: -1;
    }

    .top-row {
        display: flex;
        justify-content: space-between;
        margin-bottom: 20px;
        position: relative;
        z-index: 2;
    }

    .user-left {
        text-align: left;
    }
    .user-left .username {
        font-size: 20px;
        font-weight: 600;
    }
    .user-left .balance {
        font-size: 16px;
        color: #00ffc8;
        margin-top: 3px;
    }

    .logo-area {
        text-align: right;
    }
    .logo-area img {
        width: 60px;
        height: 60px;
        border-radius: 10px;
        border: 1px solid rgba(0,255,200,0.3);
        object-fit: cover;
    }
    .bot-name {
        font-size: 22px;
        font-weight: 700;
        margin-top: 5px;
    }
    .token-name {
        font-size: 17px;
        margin-top: 3px;
    }
    .token-ticker {
        font-size: 15px;
        opacity: 0.7;
    }

    .middle-section {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 25px;
        position: relative;
        z-index: 2;
    }

    .ref-sec {
        width: 25%;
        text-align: center;
    }
    .ref-sec img {
        width: 100px;
        height: 100px;
        margin-bottom: 10px;
        border-radius: 8px;
        border: 1px solid rgba(255,255,255,0.2);
        object-fit: cover;
    }
    .ref-text {
        font-size: 13px;
        line-height: 16px;
        word-wrap: break-word;
        background: rgba(0,0,0,0.5);
        padding: 8px;
        border-radius: 6px;
    }

    .rocket-sec img {
        width: 260px;
        height: auto;
        filter: drop-shadow(0 0 10px rgba(100,200,255,0.4));
    }

    .pnl-box {
        width: 40%;
        background: rgba(17, 17, 17, 0.7);
        padding: 18px;
        border-radius: 18px;
        box-shadow: 0 0 20px rgba(0,255,200,0.25);
        border: 1px solid rgba(0,255,200,0.35);
        text-align: left;
        backdrop-filter: blur(5px);
    }
    .pnl-title {
        font-size: 22px;
        margin-bottom: 8px;
    }
    .pnl-value {
        font-size: 34px;
        font-weight: 800;
        text-shadow: 0 0 10px rgba(0,255,123,0.15);
    }
    .pnl-value.profit {
        color: #00ff7b;
        text-shadow: 0 0 10px rgba(0,255,123,0.5);
    }
    .pnl-value.loss {
        color: #ff3b3b;
        text-shadow: 0 0 10px rgba(255,59,59,0.5);
    }

    .chart-thumb {
        margin-top: 15px;
        width: 100%;
        height: 70px;
        background: linear-gradient(45deg, #0d0d0d, #1a1a1a);
        border-radius: 10px;
        border: 1px solid rgba(255,255,255,0.1);
        position: relative;
        overflow: hidden;
    }
    
    .chart-line {
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(to top, rgba(0,255,200,0.7) 0%, transparent 100%);
        clip-path: polygon(
            0% 100%,
            10% 80%,
            20% 85%,
            30% 70%,
            40% 75%,
            50% 60%,
            60% 65%,
            70% 50%,
            80% 55%,
            90% 40%,
            100% 45%,
            100% 100%
        );
    }
    
    .chart-line.loss {
        background: linear-gradient(to top, rgba(255,59,59,0.7) 0%, transparent 100%);
        clip-path: polygon(
            0% 100%,
            10% 85%,
            20% 80%,
            30% 90%,
            40% 85%,
            50% 95%,
            60% 90%,
            70% 100%,
            80% 95%,
            90% 100%,
            100% 95%,
            100% 100%
        );
    }
    
    .chart-grid {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-image: 
            linear-gradient(rgba(255,255,255,0.05) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.05) 1px, transparent 1px);
        background-size: 20px 20px;
    }

    .download-btn {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #00ffc8;
        color: #0d0d0d;
        border: none;
        padding: 12px 20px;
        border-radius: 8px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1000;
    }
</style>

</head>
<body>

<!-- Download Button -->
<button class="download-btn" id="downloadBtn">ðŸ“¥ Download Card</button>

<div class="pnl-card" id="pnlCard">

    <!-- TOP ROW -->
    <div class="top-row">

        <!-- Left: User Info -->
        <div class="user-left">
            <div class="username" id="username">@CryptoTrader</div>
            <div class="balance" id="balance">Balance: 12,500 ALG</div>
        </div>

        <!-- Right: Logo + Bot Name + Token info -->
        <div class="logo-area">
            <!-- set crossOrigin for html2canvas -->
            <img id="logoImg" src="logo.jpg" alt="">
            <div class="bot-name">ALGORN</div>
            <div class="token-name" id="tokenName">Algorand</div>
            <div class="token-ticker" id="tokenTicker">ALG</div>
        </div>
    </div>

    <!-- MIDDLE SECTION -->
    <div class="middle-section">

        <!-- LEFT REFERRAL ADDRESS + QR -->
        <div class="ref-sec">
            <img id="qrCode" src="https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=https://t.me/algornbot?start=CRYPTO123" alt="QR Code">
            <div class="ref-text" id="referralLink">
                Referral:<br>
                https://t.me/algornbot?start=CRYPTO123
            </div>
        </div>

        <!-- ROCKET IMAGE -->
        <div class="rocket-sec">
            <img id="rocketImg" src="rocket.png" alt="">
        </div>

        <!-- PNL BOX -->
        <div class="pnl-box">
            <div class="pnl-title">PNL</div>
            <div class="pnl-value" id="pnlValue">+45.3%</div>
            <div class="chart-thumb">
                <div class="chart-grid"></div>
                <div class="chart-line" id="chartLine"></div>
            </div>
        </div>

    </div>
</div>

<script>
// Get URL parameters
function getUrlParams() {
    const params = new URLSearchParams(window.location.search);
    return {
        username: params.get('username') || '@CryptoTrader',
        balance: params.get('balance') || '12,500 ALG',
        tokenName: params.get('tokenName') || 'Algorand',
        tokenTicker: params.get('tokenTicker') || 'ALG',
        pnlValue: params.get('pnlValue') || '+45.3%',
        pnlType: params.get('pnlType') || 'profit',
        referralLink: params.get('referralLink') || 'https://t.me/algornbot?start=CRYPTO123'
    };
}

// Apply parameters to the page
function applyUrlParams() {
    const params = getUrlParams();
    console.log('URL Parameters:', params); // Debug log

    // Update username
    const usernameElement = document.getElementById('username');
    if (usernameElement) usernameElement.textContent = params.username;

    // Update balance
    const balanceElement = document.getElementById('balance');
    if (balanceElement) balanceElement.textContent = `Balance: ${params.balance}`;

    // Update token info
    const tokenNameElement = document.getElementById('tokenName');
    if (tokenNameElement) tokenNameElement.textContent = params.tokenName;

    const tokenTickerElement = document.getElementById('tokenTicker');
    if (tokenTickerElement) tokenTickerElement.textContent = params.tokenTicker;

    // Update PnL value and styling (DO NOT use decodeURIComponent here)
    const pnlValueElement = document.getElementById('pnlValue');
    if (pnlValueElement) {
        pnlValueElement.textContent = params.pnlValue;
        pnlValueElement.classList.remove('profit', 'loss');
        pnlValueElement.classList.add(params.pnlType === 'loss' ? 'loss' : 'profit');
    }

    // Update chart line styling
    const chartLineElement = document.getElementById('chartLine');
    if (chartLineElement) {
        chartLineElement.classList.remove('loss');
        if (params.pnlType === 'loss') chartLineElement.classList.add('loss');
    }

    // Update referral link and QR code
    const referralLinkElement = document.getElementById('referralLink');
    if (referralLinkElement) {
        // escape HTML to avoid accidental injection
        referralLinkElement.innerHTML = 'Referral:<br>' + escapeHtml(params.referralLink);
    }

    const qrCodeElement = document.getElementById('qrCode');
    if (qrCodeElement) {
        qrCodeElement.src = 'https://api.qrserver.com/v1/create-qr-code/?size=100x100&data=' + encodeURIComponent(params.referralLink);
        qrCodeElement.setAttribute('crossorigin', 'anonymous');
    }
}

// small helper to escape HTML in referral text
function escapeHtml(unsafe) {
    return unsafe.replace(/[&<"']/g, function(m) {
        return ({'&':'&amp;','<':'&lt;','"':'&quot;',"'":'&#039;'}[m]);
    });
}

// Preload <img> tags and CSS background-image used in .pnl-card::before
function preloadAllImages() {
    const images = Array.from(document.images).map(img => img.src).filter(Boolean);

    // attempt to read .pnl-card::before background-image
    try {
        const pnl = document.querySelector('.pnl-card');
        const styleBefore = getComputedStyle(pnl, '::before').getPropertyValue('background-image');
        // styleBefore looks like: url("...") or none
        const urlMatch = styleBefore.match(/url\((?:'|")?(.*?)(?:'|")?\)/);
        if (urlMatch && urlMatch[1]) images.push(urlMatch[1]);
    } catch (e) {
        // ignore
    }

    // dedupe
    const unique = [...new Set(images)];

    return Promise.all(unique.map(src => new Promise((resolve) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve({src, ok: true});
        img.onerror = () => resolve({src, ok: false});
        img.src = src;
        // also add timeout fallback
        setTimeout(() => resolve({src, ok: false}), 4000);
    })));
}

// Download function using html2canvas
function downloadCard() {
    // load html2canvas from CDN if not already loaded
    if (typeof html2canvas === 'undefined') {
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
        script.onload = function() {
            captureAndDownload();
        };
        document.head.appendChild(script);
    } else {
        captureAndDownload();
    }
}

function captureAndDownload() {
    const cardElement = document.getElementById('pnlCard');

    // html2canvas options: useCORS true and allowTaint false to avoid tainted canvases
    html2canvas(cardElement, {
        scale: 2,
        useCORS: true,
        allowTaint: false,
        backgroundColor: '#0d0d0d',
        logging: false,
        // try foreignObjectRendering as fallback
        foreignObjectRendering: true
    }).then(canvas => {
        const image = canvas.toDataURL('image/png');
        const link = document.createElement('a');
        link.download = `pnl-card-${Date.now()}.png`;
        link.href = image;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }).catch(error => {
        console.error('Error capturing card:', error);
        alert('Error: could not capture the card. Try hosting images with CORS enabled or use same-origin images.');
    });
}

// Wait for everything to load (images/backgrounds), then enable download
async function init() {
    applyUrlParams();

    // wait for DOM images to be added/updated (small delay)
    await new Promise(r => setTimeout(r, 100));

    // preload images and css background
    const results = await preloadAllImages();
    console.log('Preload results:', results);

    // enable download button
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.disabled = false;
    downloadBtn.addEventListener('click', () => {
        // capture after a short delay to ensure any final paints complete
        setTimeout(downloadCard, 150);
    });

    // Optional: auto-download once everything is ready
    setTimeout(() => {
        // auto-download only if user wants; comment out if undesired
        // downloadCard();
    }, 500);
}

// Auto-apply parameters when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('Page loaded, applying URL parameters...');
    init().catch(e => {
        console.error('Init error:', e);
        applyUrlParams(); // at least apply params even if preload fails
    });
});
</script>

</body>
</html>
